
<style>
    .mySpan{
        font-size: large;
        color:white;
        font-weight:bold;
        padding-left: 20px;
    }
</style>
<!--页面功能区-->
<div class="row">
    <div class="col-xs-12 col-md-12">
        <div class="widget">
            <div class="widget-body">
                <div id="cc" class="easyui-layout" data-options="fit:true,border:false" style="width: 900px; height:580px;background-color: #fbfbfb;">
                    <div data-options="region:'center',border:false" style="overflow-x:hidden;overflow-y:hidden">
                        <div id="toolbar" class="row tbRow">
                            <div class="col-xs-4 col-md-4">
                                <div class="btn-group" role="group" aria-label="...">
                                    <button type="button" class="btn btn-default azure" onclick="showDetail();" data-title="查看详情">
                                        <i class="glyphicon glyphicon-eye-open"></i> 查看
                                    </button>
                                    <button type="button" class="btn btn-default azure" onclick="openPmRecord();" data-title="查看详情">
                                        <i class="glyphicon glyphicon-list-alt"></i> 查看任务记录
                                    </button>

                                    <button type="button" class="btn btn-default azure" onclick="doDel();" data-title="项目变更日志">
                                        <i class="glyphicon glyphicon-trash"></i> 删除
                                    </button>
                                </div>
                            </div>
                            <div class="col-xs-8 col-md-8 text-right">
                                <form id="searchFrom" class="form-inline">
                                    <div class="form-group" id="org_codeSelectDiv">
                                        <div class="input-group">
                                            <input class="easyui-combobox" id="yearSele" name="yearSele" style="width: 130px;height:34px;"
                                                   data-options="valueField:'id',textField:'text'"  >
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="input-group">
                                            <input type="input" id="sname" name="sname" class="form-control" style="width:200px;" placeholder="任务名">
                                                    <span class="input-group-btn">
                                                        <button class="btn btn-default" type="button" onclick="doSearch()"><i class="fa fa-search"></i>查询</button>
                                                    </span>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <table id="simpledatatable">

                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!--页面功能区结束-->
<!--查看窗口窗体开始-->
<div class="mydialog">
    <div id="lookUpModal">
        <div class="row">
            <div class="col-md-12">
                <form id="pmForm" class="form-horizontal form-bordered" role="form"
                      enctype="multipart/form-data">
                    <div class="form-group">
                        <div class="col-sm-9" align="center" style="margin: 5px">
                            <!--窗口上方留白-->
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inputNo"
                               class="col-sm-2 control-label no-padding-right">任务编号</label>
                        <div class="col-sm-9">
                            <input readonly="on" type="text" class="easyui-validatebox form-control"
                                   data-options="required:true" style="width:100%;color:#050505" name="pm_no"
                                   id="pm_no">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inputName"
                               class="col-sm-2 control-label no-padding-right">任务名称</label>
                        <div class="col-sm-9">
                            <input readonly="on" type="text" class="easyui-validatebox form-control"
                                   data-options="required:true" style="width:100%;color:#050505" name="pm_name"
                                   id="pm_name">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inputMobile"
                               class="col-sm-2 control-label no-padding-right">项目内容</label>
                        <div class="col-sm-9">
                            <textarea readonly="on"  class="easyui-validatebox form-control"
                                      data-options="required:true" style="width:100%;height:100px;color:#050505" name="pm_content"
                                      id="pm_content"></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inputName"
                               class="col-sm-2 control-label no-padding-right">责任室</label>
                        <div class="col-sm-9">
                            <input readonly="on" type="text" class="easyui-validatebox form-control"
                                   data-options="required:true" style="width:100%;color:#050505" name="pm_responsibilityRoom"
                                   id="pm_responsibilityRoom">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inputAge"
                               class="col-sm-2 control-label no-padding-right">责任人</label>
                        <div class="col-sm-9">

                            <input readonly="on" type="text" class="easyui-validatebox form-control"
                                   data-options="required:true" style="width:100%;color:#050505" name="pm_responsibilityPerson"
                                   id="pm_ResponsibilityPerson">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inputStatus"
                               class="col-sm-2 control-label no-padding-right">开始时间</label>
                        <div class="col-sm-9">
                            <input readonly="on" type="text" class="easyui-validatebox form-control"
                                   data-options="required:true" style="width:100%;color:#050505" name="pm_begin_date"
                                   id="pm_begin_date">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inputStatus"
                               class="col-sm-2 control-label no-padding-right">结束时间</label>
                        <div class="col-sm-9">
                            <input readonly="on" type="text" class="easyui-validatebox form-control"
                                   data-options="required:true" style="width:100%;color:#050505" name="pm_end_date"
                                   id="pm_end_date">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inputStatus"
                               class="col-sm-2 control-label no-padding-right">提醒时间</label>
                        <div class="col-sm-9">
                            <input readonly="on" type="text" class="easyui-validatebox form-control"
                                   data-options="required:true" style="width:100%;color:#050505" name="pm_remind_date"
                                   id="pm_remind_date">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inputName"
                               class="col-sm-2 control-label no-padding-right">任务类型</label>
                        <div class="col-sm-9">
                            <input readonly="on" type="text" class="easyui-validatebox form-control"
                                   data-options="required:true" style="width:100%;color:#050505" name="pm_type"
                                   id="pm_type">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inputName"
                               class="col-sm-2 control-label no-padding-right">任务状态</label>
                        <div class="col-sm-9">
                            <input readonly="on" type="text" class="easyui-validatebox form-control"
                                   data-options="required:true" style="width:100%;color:#050505" name="pm_status"
                                   id="pm_status">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inputName"
                               class="col-sm-2 control-label no-padding-right">任务进度</label>
                        <div class="col-sm-9">
                            <div id="progress_bar_illidan" class="easyui-progressbar"  style="width:400px;"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inputName"
                               class="col-sm-2 control-label no-padding-right">紧急程度</label>
                        <div class="col-sm-9">
                            <input readonly="on" type="text" class="easyui-validatebox form-control"
                                   data-options="required:true" style="width:100%;color:#050505" name="pm_urgent_degree"
                                   id="pm_urgent_degree">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="inputName"
                               class="col-sm-2 control-label no-padding-right">任务附件</label>
                        <div class="col-sm-9">
                            <div class="btn-group" role="group" aria-label="...">
                                <button type="button" class="btn btn-default">
                                    <!--由查看函数修改该href为文件路径-->
                                    <a href="#" id="downURL" download="">下载附件文件</a></button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inputName"
                               class="col-sm-2 control-label no-padding-right">发送人</label>
                        <div class="col-sm-9">
                            <input readonly="on" type="text" class="easyui-validatebox form-control"
                                   data-options="required:true" style="width:100%;color:#050505" name="pm_sendPerson"
                                   id="pm_sendPerson">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inputName"
                               class="col-sm-2 control-label no-padding-right">接收人</label>
                        <div class="col-sm-9">
                            <input readonly="on" type="text" class="easyui-validatebox form-control"
                                   data-options="required:true" style="width:100%;color:#050505" name="pm_sendPerson"
                                   id="pm_sendPerson">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inputName"
                               class="col-sm-2 control-label no-padding-right">任务备注</label>
                        <div class="col-sm-9">
                            <input readonly="on" type="text" class="easyui-validatebox form-control"
                                   data-options="required:true" style="width:100%;color:#050505" name="pm_remark"
                                   id="pm_remark">
                        </div>
                    </div>
                    <div class="col-sm-9" align="center" style="margin: 5px">
                        <!--窗口下方留白-->
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!--查看窗口窗体结束-->
<!--接收人-->
<div class="mydialog">
    <div id="receiveModal">
        <table id="receiveTable" width="100%;">

        </table>
    </div>
</div>
<!--结束-->
<!--任务记录区-->
<div class="mydialog">
    <div id="recordModal">
        <div class="input-group">
            <textarea  style="width: 575px;height: 350px;margin: 5px;resize:none;font-size: 17px;font-family:Microsoft Yahei; " id="pm_record" name="pm_record" class="form-control" placeholder="任务记录..." aria-describedby="basic-addon2"></textarea>
        </div>
    </div>
</div>
<!--结束-->
<script>
    var appurl = '{{projcfg.appurl}}/api/pm/pm/que?status=2';
    $(document).ready(function() {
        $(function(){
            <!--datagird数据处理-->
            $('#simpledatatable').datagrid({
                url:'{{projcfg.appurl}}/api/pm/pm/que?status=2',
                method:'get',
                title:"已完成",
                height:500,
                striped:true,
                fitColumns:false,
                border:true,
                singleSelect:true,
                selectOnCheck:false,
                columns:[[
                    {field: '_id', checkbox: true},
                    {"field": "pm_name", "title": "任务名称", "width": 128,"sortable":true},
                    {"field": "pm_content", "title": "任务内容", "width": 145},
                    {"field": "pm_responsibilityRoom", "title": "责任室", "width": 90},
                    {"field": "pm_responsibilityPerson", "title": "责任人", "width": 90},
                    {"field": "pm_begin_date", "title": "开始时间", "width": 89,"sortable":true},
                    {"field": "pm_end_date", "title": "结束时间", "width": 89,"sortable":true},
                    {
                        "field": "pm_type", "title": "任务类型", "width": 80,
                        "formatter": function (data, rowData, rowIndex) {
                            switch (data) {
                                case '0':
                                    return '项目管理';
                                case '1':
                                    return '日程安排';
                                case '2':
                                    return '工作计划';
                            }
                        }
                    },
                    {
                        "field": "pm_speed_of_progress", "title": "任务进度", "width": 80,
                        "formatter": function (data, rowData, rowIndex) {
                            return data + '%';
                        }
                    },
                    {
                        "field": "pm_urgent_degree", "title": "紧急程度", "width": 80,
                        "formatter": function (data, rowData, rowIndex) {
                            switch (data) {
                                case '0':
                                    return '一般';
                                case '1':
                                    return '紧急';
                                case '2':
                                    return '非常紧急';
                            }
                        }
                    },
                    {"field": "pm_sendPerson", "title": "发送人", "width": 60},
                    {"field": "pm_receivePerson", "title": "接收人", "width": 100,"formatter":
                            function (data, rowData, rowIndex) {
                                var param = JSON.stringify(data);
                                return "<button type='button' class='btn btn-default' onclick='lookUp(" + param + ")' data-title='查看' ><i  class='glyphicon glyphicon-zoom-in' > 查看</i></button>";
                            }
                    }

                ]],
                onDblClickRow:function(rowIndex, rowData){
                    showDetail();
                },
                onLoadSuccess:function(json) {
                    if(!json.success) {
                        msgError(json.msg);
                    }
                },
                onLoadError:function() {
                    msgError('加载数据出现时发生错误,请稍候重试...');
                },
                pagination:true,
                loadMsg:'正在加载...'
            });



            initCom();

            var role_code = '{{currentUserRole.role_code}}';
            var org_code ='{{currentUser.user_org.org_code}}';
            var login_account ='{{currentUser.login_account}}';

            if(org_code!="000102"&&login_account!="yangruofan"){
                if(role_code == "001"||role_code == "sysadmin"||role_code == "002"||role_code == "005"||role_code == "007"){
                    $('#org_codeSelectDiv').show();
                }else {
                    $('#org_codeSelectDiv').hide();
                    $('#activeCss').css({
                        "margin-left":"150px"
                    });
                }
            }else{
                $('#org_codeSelectDiv').show();
            }

        });
    });

    /**
     * 查看一行数据
     * @returns {boolean}
     */
    function showDetail() {
        var rows = $('#simpledatatable').datagrid('getChecked');
        if (rows.length != 1) {
            msgError('提示,请选择一条数据再进行查看');
            return false;
        }
        var id = rows[0]._id;
        openPageForLookUp("查看数据", id);
        // 获取远程数据
        $.ajax({
            url: '{{projcfg.appurl}}/api/pm/pm/'+id,
            type: 'get',
            data: {},
            success: function (data) {
                if (data.success) {
                    $('#lookUpModal').form('load',data.data[0]);
                    //其他数据装载
                    $('#progress_bar_illidan').progressbar('setValue',data.data[0].pm_speed_of_progress);//进度条设置
                    $('#downURL').attr("href",'../../../public/static/file/'+data.data[0].pmd_enclosure);//下载链接设置
                    $('#downURL').attr("download",data.data[0].pmd_enclosure);//下载文件名设置
                }
                else {
                    msgError(data.msg + ',错误代码:' + data.code);
                }
            }
        });
    }

    /**
     * 由于查看页面与修改新增页面有许多不同，包括下载链接、接收人、发送人等都不一样故用一个新的方法
     * @param title
     * @param value
     */
    function openPageForLookUp(title, value) {
        $('#lookUpModal').show();
        //获取滚动条到顶部的垂直高度
        var scrollHei=$(document).scrollTop();
        $('#lookUpModal').mydialog({
            title: title,
            autoOpen: false,
            width: 600,
            height: 600,
            top: scrollHei+15,
            modal: true,
            myButtons: [
                {
                    text: '关闭',
                    btnCls: 'btn btn-danger',
                    handler: function () {
                        $('#lookUpModal').dialog('close');
                    }
                }
            ]
        });
    }

    /**
     * 删除一行数据
     * @returns {boolean}
     */
    function doDel() {

        // 获得选择行
        var rows = $('#simpledatatable').datagrid('getChecked');
        if (rows.length != 1) {
            msgError('提示,请选择一条数据再进行删除');
            return false;
        }
        var id = rows[0]._id;
        //当前用户是否是任务发起者
        if ('{{currentUser._id}}' === rows[0].pm_sendPersonID){
        msgConfirm('确定删除此条记录？', function (result) {
            if (result) {
                // 获取远程数据
                $.ajax({
                    url: '{{projcfg.appurl}}/api/pm/pm/' + id,
                    type: 'delete',
                    data: {},
                    success: function (data) {
                        if (data.success) {
                            msgSuccess(data.msg);
                            doSearch();
                        }
                        else {
                            msgError(data.msg + ',错误代码:' + data.code);
                        }
                    }
                });
            }
        });}else{
            msgError('非发起者不能删除该任务。');
        }
    }

    /**
     * 排序、根据任务名查询、根据开始时间年度查询  入口
     */
    function doSearch() {
        $('#simpledatatable').datagrid('reload', {'name': $('#sname').val(),'year':$('#yearSele').combobox('getValue')});
    }
    /**
     * 初始化下拉列表
     */
    function initCom() {
        $.ajax({
            url:'{{projcfg.appurl}}/api/pm/pm/getYear',
            type: 'get',
            success: function (data) {
                if (data.success) {
                    $('#yearSele').combobox('setValue','选择开始时间年度');
                    $('#yearSele').combobox('loadData',data.data);
                }
                else {
                    msgError(data.msg + ',错误代码:' + data.code);
                }
            }
        });
    }
    /**
     * 查看接收人
     * @returns {boolean}
     */
    function lookUp(vv) {
        var noRepeat={};
        receiveArr=[];
        //去掉重复数据
        for(var i=0;i<vv.length; i++){
            noRepeat[vv[i].name]=vv[i].name;
        }
        //遍历去重后的数据
        for(var i in noRepeat){
            receiveArr.push(noRepeat[i]);
        }
        $('#receiveTable').prepend('<ul class="list-group" >');
        for (var i=0;i<receiveArr.length; i++)
            $('#receiveTable').prepend('<li class="list-group-item" align="center">'+receiveArr[i]+'</li>');
        $('#receiveTable').append('</ul>');

        //获取滚动条到顶部的垂直高度
        var scrollHei=$(document).scrollTop();
        $('#receiveModal').show();
        $('#receiveModal').mydialog({
            title: '接收人',
            width: 200,
            height: 300,
            top: scrollHei+100,
            modal: true,
            myButtons: [
                {
                    text: '关闭',
                    btnCls: 'btn btn-danger',
                    handler: function () {
                        $('#receiveTable').empty();
                        $('#receiveModal').dialog('close');
                    }
                }
            ]
        });
    }

    /**
     * 打开任务记录界面
     * 选择一条任务数据，ajax读取任务的任务记录显示在
     * @returns {boolean}
     */

    function openPmRecord() {
        var rows = $('#simpledatatable').datagrid('getChecked');
        if (rows.length != 1) {
            msgError('提示,请选择一条数据再进行删除');
            return false;
        }

        var id=rows[0]._id;
        var type=rows[0].pm_type;
        if(type==='0'){
            $.ajax({
                url: '{{projcfg.appurl}}/api/pm/pm/' + id,
                type: 'get',
                data: {},
                success: function (data) {
                    if (data.success) {
                        recordList=data.data[0].pm_record;
                        $("#pm_record").val('');
                        for(var i in recordList){

                            if(recordList[i].senderName!==undefined&&recordList[i].senderName!==null&&recordList[i].senderName!==''&&recordList[i].message!==undefined&&recordList[i].message!==''&&recordList[i].message!==null)
                                $("#pm_record").val($("#pm_record").val()+recordList[i].senderName+":"+recordList[i].message+"\n");
                        }
                        $("#recordInformation").val('');
                    }
                    else {
                        msgError(data.msg + ',错误代码:' + data.code);
                    }
                }
            });

            $('#recordModal').show();
            $('#recordModal').mydialog({
                title: '任务记录',
                width: 600,
                height: 450,
                top: 50,
                modal: true,
                myButtons: [
                    {
                        text: '关闭',
                        btnCls: 'btn btn-danger',
                        handler: function () {
                            $("#recordInformation").val('');
                            $("#pm_record").val('');
                            $('#recordModal').dialog('close');
                        }
                    }
                ]
            });
        }else{
            msgError('通知类任务没有任务记录。');
        }
    }
</script>